<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Native GNU nano text editor in CoreOS. &middot; source{d} blog</title>
    <meta name="author" content="source{d}">
    <meta name="description" content="coding to find awesome engineers">
    <meta name="generator" content="Hugo 0.15" />
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/2.1.2/normalize.min.css">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/screen.css">
    <link rel="stylesheet" href="/css/github.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/styles/default.min.css">

    <!-- Stylesheet for theme color -->
    <style type="text/css">
    a, a:visited {color: #32526A; font-weight: 600; }
    .pagination a {color: #111111;}
    .gist .gist-file .gist-meta a:visited {color: #111111 !important;}
    a:focus, a:hover {color: #32526A;}
    h1.post-title, h1.blog-title a, h1.blog-title a {
      color: #32526A;
    }

    h1.post-title a:focus, h1.post-title a:hover, h1.blog-title a:focus, h1.blog-title a:hover {
      color: #000;
    }
    .older-posts:hover, .newer-posts:hover {color: #32526A;}

    .post-meta .authorimage {
      zoom:.5;
    }

    .post-meta {
      text-transform: none;
    }

    .post .post-meta {
      margin-bottom: 50px;
    }

    .preview .post-meta p { margin:0; }
    .preview .post-meta .authorimage {
      display:none;
    }

    .preview .image  {
      height: 90px;
      margin: auto;
      overflow: hidden;
      background-size: cover;
      background-position: center center;
    }

    .preview .image img {
      display: block;
      margin: 0 auto;
      max-width: 100%;
    }
</style>

</head>
<body class="post-template">

    <div id="nav">
  <ul class="nav-list">
    <li class="nav-list-item"><a href="http://sourced.tech">sourced.tech</a></li>
  </ul>
</div>


<header id="site-head">
	
	<h1 class="blog-title"><a href="/">source{d}</a></h1>
	
	
	<h1 class="blog-subtitle">coding to find awesome engineers</h1>
	
  <span class="blog-sub-link">Take me to <a href="http://sourced.tech">sourced.tech</a></span>
</header>
    

    <main class="content" role="main">
	    <article class="post">
	        <header>
	        <h1 class="post-title">Native GNU nano text editor in CoreOS.</h1>
	        <div class="post-meta">
            

    <div class="authorimage" style="background: url(https://avatars0.githubusercontent.com/u/2793551?v=3&amp;s=460)"></div>
    <p>
      by <b>Vadim Markovtsev</b>
      <time datetime="17 November 2016">17 November 2016</time></div>
    </p>


	        </header>
	        <section class="post-content">
	            

<p>Sometimes, you want to edit text files inside CoreOS. Either you have to use the Vim
editor which is shipped by default or use a container, e.g. Toolbox. I am not a fan
Vim and feel that using a container to launch a text editor for temporal edits
is overkill. I am used to <a href="https://www.nano-editor.org/">GNU nano</a> and I would like
to use it instead of Vim. Since there is no package manager in CoreOS (and it
shouldn&rsquo;t have one of course), one has to either copy the <code>nano</code> binary from a donor container
or compile it from scratch. The binary is linked dynamically in all Linux distributions,
so launching it in CoreOS fails with &ldquo;library not found&rdquo; errors. Let&rsquo;s face it:
<code>nano</code> must be compiled in order to work with all the features.</p>

<p><img src="/post/coreos_nano/nano.png" alt="nano" /></p>

<p>I am used to Ubuntu, so I will cook <code>nano</code> in it&rsquo;s environment. The following supposes
that you have access to the CoreOS command line prompt.</p>

<h4 id="prepare-the-system:4c09a45dcc65e194fab65d0b8616f5c5">Prepare the system</h4>

<pre><code># Override toolbox from Fedora to Ubuntu
echo &quot;TOOLBOX_DOCKER_IMAGE=ubuntu&quot; &gt; ~/.toolboxrc
toolbox

# The next commands are issued inside the container
apt build-dep nano
apt install libmagic-dev libgpm-dev wget
wget https://www.nano-editor.org/dist/v2.7/nano-2.7.1.tar.gz
tar -xf nano-2.7.1.tar.gz
cd nano-2.7.1
</code></pre>

<p><code>build-dep</code> should install the C compiler and all the build dependencies, however,
two extra libraries must be installed: <a href="https://github.com/file/file">libmagic</a>
enables <code>nano</code> to select the syntax highlight scheme based on the edited file&rsquo;s
contents (by the way, <code>file</code> command in Linux is based on the same library) and
libgpm is one of the opaque dependencies of <a href="https://www.gnu.org/software/ncurses/">libncurses</a>.
libncurses in turn is the library to create console user interfaces. Basically, every program
which has a console UI uses it: <code>vim</code>, <code>mc</code>, <code>less</code> and <code>more</code> and even web browsers like <code>w3m</code>.
Usually it is accompanied with <a href="https://cnswww.cns.cwru.edu/php/chet/readline/rltop.html">libreadline</a>,
an essential abstraction layer to work with the terminal prompt, it is used by
Bash, Vim, Python REPL, etc. By the way, every time you press Ctrl-R in the terminal, you use libreadline.</p>

<h4 id="building:4c09a45dcc65e194fab65d0b8616f5c5">Building</h4>

<pre><code>mkdir build &amp;&amp; cd build
# The tricky part
../configure --enable-utf8 --prefix=/opt CFLAGS=&quot;-flto -O2 -march=native&quot; LDFLAGS=&quot;-static&quot; LIBS=&quot;-ltinfo -lgpm -lz&quot;
make -j$(getconf _NPROCESSORS_ONLN)
mkdir install &amp;&amp; make install DESTDIR=$(pwd)/install
</code></pre>

<p>The point is, we <strong>must</strong> compile <code>nano</code> statically linked, because CoreOS&rsquo;s <code>/etc/ldconfig</code>
library paths are all readonly (e.g., /opt/lib could be a
good candidate but is not listed). <code>nano</code>&rsquo;s dependency libraries are indeed not
present in CoreOS and there is no way to add them nicely (<code>LD_LIBRARY_PATH</code>,
<code>LD_PRELOAD</code> are hacks which should be avoided). If <code>nano</code> was written in Go,
there would be no problem since the Go compiler always links programs statically.
Unfortunately, we have to deal with C.</p>

<p><code>nano</code> is traditional GNU software which is built using
<a href="https://en.wikipedia.org/wiki/GNU_Build_System">autotools</a> and
<a href="https://en.wikipedia.org/wiki/Make_(software">make</a>). The build is performed
in three steps:</p>

<ol>
<li>Generate the <code>configure</code> script. Usually, maintainers ship it inside the source tarball.</li>
<li>Run <code>configure</code> script to create the makefiles, check the environment, etc.</li>
<li>Run <code>make</code> - compile everything.</li>
<li>Run <code>make install</code> to put the built files into the desired location. Sometimes, libraries get relinked to match the destination directory.</li>
</ol>

<p>GCC offers a <code>-static</code> flag which we can inject via LDFLAGS during the configuration step.
However, it will fail then. The problem is in dependencies: for example,
ncurses depends on libtinfo and it is not linked automatically. The described
situation is total hell in case of large programs with plenty of dependencies.
We are lucky that we&rsquo;ve got the tiny <code>nano</code>!</p>

<pre><code>ldd $(which nano)
    linux-vdso.so.1 (0x00007ffdc091c000)
    libmagic.so.1 =&gt; /lib64/libmagic.so.1 (0x00007f6ebe62a000)
    libncursesw.so.6 =&gt; /lib64/libncursesw.so.6 (0x00007f6ebe3f1000)
    libtinfo.so.6 =&gt; /lib64/libtinfo.so.6 (0x00007f6ebe1c4000)
    libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f6ebde01000)
    libz.so.1 =&gt; /lib64/libz.so.1 (0x00007f6ebdbeb000)
    libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f6ebd9e6000)
    /lib64/ld-linux-x86-64.so.2 (0x00005597ae3f0000)
</code></pre>

<p>The dependencies can be added manually and this is what I did with setting LIBS.
libc and libdl are not needed to append - they are system stuff.</p>

<p>Finally, CFLAGS activates <a href="https://en.wikipedia.org/wiki/Interprocedural_optimization">link time optimization</a>
which is a must-have if you link statically, sets optimization level and allows
the compiler to optimize for the current hardware.</p>

<h4 id="installing:4c09a45dcc65e194fab65d0b8616f5c5">Installing</h4>

<pre><code>mkdir /media/root/opt/{bin,share,etc}
cp install/opt/bin/nano /media/root/opt/bin
cp -r install/opt/share/nano /media/root/opt/share
echo &quot;include /opt/share/nano/*.nanorc&quot; &gt; /media/root/opt/etc/nanorc
</code></pre>

<p>Here we are using the fact that CoreOS lists <code>/opt/bin</code> in <code>PATH</code> and effectively
allows adding your custom binaries. Additionally, we write the nanorc configuration
to activate syntax highlight rules.</p>

<p>That&rsquo;s it!</p>

<pre><code>nano --version
 GNU nano, version 2.7.1
 (C) 1999..2016 Free Software Foundation, Inc.
 (C) 2014..2016 the contributors to nano
 Email: nano@nano-editor.org	Web: https://nano-editor.org/
 Compiled options: --enable-utf8
</code></pre>

<p><a href="https://drive.google.com/open?id=0B-w8jGUJto0iNzVBakZ3UUxLZGs">Binary download link.</a></p>

<h4 id="now-seriously:4c09a45dcc65e194fab65d0b8616f5c5">Now seriously</h4>

<p>As we saw, it is possible to statically link C/C++ programs in pretty much the
same way Go does it. In Go, you execute <code>go get</code> and you are done. In C, you
have to be a good system programmer and to spend an hour struggling with the compiler.
My next text editor will be written in Go for sure&hellip; or Vim.</p>

	        </section>

          <footer class="post-footer">
              

<section class="author">
    <div class="authorimage" style="background: url(https://avatars0.githubusercontent.com/u/2793551?v=3&amp;s=460)"></div>
    <h4>
      Vadim Markovtsev
      
      <a href="//github.com/vmarkovtsev" target="_blank" title="GitHub">
        <i class="fa fa-2x fa-fw fa-github"></i>
        <span class="hidden">GitHub</span>
      </a>
      
      
      <a href="//twitter.com/@tmarkhor" target="_blank" title="Twitter">
        <i class="fa fa-2x fa-fw fa-twitter"></i>
        <span class="hidden">Twitter</span>
      </a>
      
    </h4>

    <p class="meta">
    </p>

    <p class="bio">A former system programmer, Vadim is now a machine learning engineer in love with deep neural networks.</p>

</section>


          </footer>

          <section class="mailchimp">  
            
            <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
            <style type="text/css">
              #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; width:100%;}
               
            </style>
            <div id="mc_embed_signup">
            <form action="//tech.us13.list-manage.com/subscribe/post?u=0eae08951c21c9bca382c2c2e&amp;id=9814bef9fd" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
                <div id="mc_embed_signup_scroll">
              <label for="mce-EMAIL">Receive new posts via email</label>
              <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
                
                <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_0eae08951c21c9bca382c2c2e_9814bef9fd" tabindex="-1" value=""></div>
                <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
                </div>
            </form>
            </div>
            
          </section>

			
	        	
	        

			


	        <section class="share">
	            <p class="backtotop"><a data-scroll href="#site-head"><i class="fa fa-lg fa-fw fa-angle-double-up"></i></a><a data-scroll class="backtotoptext" href="#site-head"> Back to top</a></p>
	            <p class="info prompt">Share</p>
	            <a href="http://twitter.com/share?text=Native%20GNU%20nano%20text%20editor%20in%20CoreOS.&url=%2fpost%2fcoreos_nano%2f" title="Share on Twitter"
	                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
	                <i class="fa fa-2x fa-fw fa-twitter-square"></i> <span class="hidden">Twitter</span>
	            </a>
	            <a href="https://www.facebook.com/sharer/sharer.php?u=%2fpost%2fcoreos_nano%2f" title="Share on Facebook"
	                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
	                <i class="fa fa-2x fa-fw fa-facebook-square" style="margin-left: -8px"></i> <span class="hidden">Facebook</span>
	            </a>
	            <a href="https://plus.google.com/share?url=%2fpost%2fcoreos_nano%2f" title="Share on Google+"
	               onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
	                <i class="fa fa-2x fa-fw fa-google-plus-square" style="margin-left: -8px"></i> <span class="hidden">Google+</span>
	            </a>
	        </section>


	    </article>
	</main>

    <footer class="site-footer">
	<div class="inner">
		<section class="footer-social">
			
		    <a href="//twitter.com/srcd_" target="_blank" title="Twitter"><i class="fa fa-2x fa-fw fa-twitter"></i> <span class="hidden">Twitter</span></a>&nbsp;
		    
		    
		    <a href="//github.com/src-d" target="_blank" title="GitHub"><i class="fa fa-2x fa-fw fa-github"></i> <span class="hidden">GitHub</span></a>&nbsp;
		    
		    
		</section>

		<section class="copyright">&copy; 2016 <a href="/">source{d}</a>. Crafted with love.</section>
	</div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script src="/js/smooth-scroll.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/highlight.min.js"></script>

<script>
    smoothScroll.init({
        speed: 800,
        easing: 'easeInOutCubic',
        updateURL: false,
        offset: 125,
    });
</script>
<script>hljs.initHighlightingOnLoad();</script>


<!-- Google Analytics -->
<script>
  var _gaq=[['_setAccount','UA-69608223-2'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>



<script>
   (function(h,o,t,j,a,r){
       h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
       h._hjSettings={hjid:184958,hjsv:5};
       a=o.getElementsByTagName('head')[0];
       r=o.createElement('script');r.async=1;
       r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
       a.appendChild(r);
   })(window,document,'//static.hotjar.com/c/hotjar-','.js?sv=');
</script>

<script type="text/javascript">
    adroll_adv_id = "IYZYMSZIZZGURCHNYRRKTA";
    adroll_pix_id = "MXWTIGH3ZNCXDAD4UGQIW5";
     
     
    (function () {
        var _onload = function(){
            if (document.readyState && !/loaded|complete/.test(document.readyState)){setTimeout(_onload, 10);return}
            if (!window.__adroll_loaded){__adroll_loaded=true;setTimeout(_onload, 50);return}
            var scr = document.createElement("script");
            var host = (("https:" == document.location.protocol) ? "https://s.adroll.com" : "http://a.adroll.com");
            scr.setAttribute('async', 'true');
            scr.type = "text/javascript";
            scr.src = host + "/j/roundtrip.js";
            ((document.getElementsByTagName('head') || [null])[0] ||
                document.getElementsByTagName('script')[0].parentNode).appendChild(scr);
        };
        if (window.addEventListener) {window.addEventListener('load', _onload, false);}
        else {window.attachEvent('onload', _onload)}
    }());
</script>


</body>
</html>
